<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFF Web Search</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 50px auto; background: #1e1e1e; color: #d4d4d4; }
        input { width: 100%; padding: 15px; font-size: 18px; background: #2d2d2d; border: 1px solid #444; color: white; outline: none; box-sizing: border-box; }
        input:focus { border-color: #569cd6; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.15s; }
        li:hover { background: #3c3c3c; }
        li.cached-item { border-left: 3px solid #4ec9b0; padding-left: 7px; background: #4ec9b010; }
        li.boosted { border-left: 3px solid #569cd6; padding-left: 7px; }
        li.just-cached { animation: flash 0.5s ease; }
        @keyframes flash { 0%, 100% { background: #3c3c3c; } 50% { background: #4ec9b050; } }
        .boost-badge { background: #4ec9b0; color: #1e1e1e; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px; }
        .section-header { font-size: 11px; color: #4ec9b0; padding: 8px 10px; background: #252525; border-bottom: 1px solid #333; text-transform: uppercase; letter-spacing: 1px; }
        .section-header.normal { color: #888; }
        .recent-section { margin: 15px 0; }
        .recent-title { font-size: 12px; color: #888; margin-bottom: 8px; }
        .recent-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .recent-tag { background: #2d2d2d; border: 1px solid #444; padding: 4px 10px; border-radius: 12px; font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .recent-tag:hover { background: #3c3c3c; border-color: #569cd6; }
        .status-bar { display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 10px; padding: 5px 0; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #4ec9b0; color: #1e1e1e; padding: 10px 16px; border-radius: 6px; font-size: 13px; opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <h1>Go Fuzzy Finder</h1>
    <input type="text" id="search" placeholder="Type to search files..." autofocus oninput="doSearch()">
    
    <div class="recent-section" id="recentSection" style="display: none;">
        <div class="recent-title">Recent searches:</div>
        <div class="recent-tags" id="recentTags"></div>
    </div>
    
    <div id="recentFilesSection" style="display: none;">
        <div class="section-header">Recent results</div>
        <ul id="recentFilesList"></ul>
    </div>
    
    <div id="cachedSection" style="display: none;">
        <div class="section-header">From cache</div>
        <ul id="cachedResults"></ul>
    </div>
    
    <div id="normalSection" style="display: none;">
        <div class="section-header normal">Search results</div>
        <ul id="results"></ul>
    </div>
    
    <div class="status-bar">
        <span>Cache: <span id="cacheSize">0</span> queries</span>
        <span>Click to cache</span>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        let timeout;
        let lastQuery = '';

        function doSearch() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const query = document.getElementById('search').value;
                lastQuery = query;
                
                if (query.length > 0) {
                    document.getElementById('recentSection').style.display = 'none';
                    document.getElementById('recentFilesSection').style.display = 'none';
                } else {
                    loadRecentSearches();
                    loadRecentFiles();
                    document.getElementById('cachedSection').style.display = 'none';
                    document.getElementById('normalSection').style.display = 'none';
                    return;
                }
                
                fetch('/search?q=' + encodeURIComponent(query))
                    .then(res => res.json())
                    .then(data => {
                        const cachedSection = document.getElementById('cachedSection');
                        const cachedList = document.getElementById('cachedResults');
                        
                        if (data.cached_files && data.cached_files.length > 0) {
                            cachedSection.style.display = 'block';
                            cachedList.innerHTML = '';
                            
                            data.cached_files.forEach(filePath => {
                                const li = document.createElement('li');
                                li.className = 'cached-item';
                                li.textContent = filePath;
                                li.dataset.path = filePath;
                                
                                const badge = document.createElement('span');
                                badge.className = 'boost-badge';
                                badge.textContent = 'cached';
                                li.appendChild(badge);
                                
                                li.onclick = () => recordSelection(query, filePath, li);
                                cachedList.appendChild(li);
                            });
                        } else {
                            cachedSection.style.display = 'none';
                        }
                        
                        const normalSection = document.getElementById('normalSection');
                        const list = document.getElementById('results');
                        
                        if (data.results && data.results.length > 0) {
                            normalSection.style.display = 'block';
                            list.innerHTML = '';
                            
                            data.results.forEach(item => {
                                const li = document.createElement('li');
                                li.textContent = item.path;
                                li.dataset.path = item.path;
                                
                                if (item.boosted) {
                                    li.classList.add('boosted');
                                    const badge = document.createElement('span');
                                    badge.className = 'boost-badge';
                                    badge.textContent = 'cached';
                                    li.appendChild(badge);
                                }
                                
                                li.onclick = () => recordSelection(query, item.path, li);
                                list.appendChild(li);
                            });
                        } else {
                            normalSection.style.display = 'none';
                        }
                    });
            }, 100);
        }

        function recordSelection(query, filePath, element) {
            fetch('/record-selection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query, path: filePath })
            }).then(() => {
                element.classList.add('just-cached');
                setTimeout(() => element.classList.remove('just-cached'), 500);
                
                if (!element.querySelector('.boost-badge')) {
                    element.classList.add('boosted');
                    const badge = document.createElement('span');
                    badge.className = 'boost-badge';
                    badge.textContent = 'cached';
                    element.appendChild(badge);
                }
                
                showToast('Cached: ' + filePath.split('/').pop());
                updateCacheInfo();
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function updateCacheInfo() {
            fetch('/cache-info')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('cacheSize').textContent = data.size;
                    window.recentQueries = data.recent_queries || [];
                    window.recentFiles = data.recent_files || [];
                    
                    if (document.getElementById('search').value === '') {
                        loadRecentSearches();
                        loadRecentFiles();
                    }
                });
        }

        function loadRecentSearches() {
            const section = document.getElementById('recentSection');
            const container = document.getElementById('recentTags');
            
            if (!window.recentQueries || window.recentQueries.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            window.recentQueries.forEach(query => {
                const tag = document.createElement('span');
                tag.className = 'recent-tag';
                tag.textContent = query;
                tag.onclick = () => {
                    document.getElementById('search').value = query;
                    doSearch();
                };
                container.appendChild(tag);
            });
        }

        function loadRecentFiles() {
            const section = document.getElementById('recentFilesSection');
            const list = document.getElementById('recentFilesList');
            
            if (!window.recentFiles || window.recentFiles.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            window.recentFiles.forEach(filePath => {
                const li = document.createElement('li');
                li.className = 'cached-item';
                li.textContent = filePath;
                li.dataset.path = filePath;
                
                const badge = document.createElement('span');
                badge.className = 'boost-badge';
                badge.textContent = 'cached';
                li.appendChild(badge);
                
                li.onclick = () => {
                    showToast(filePath.split('/').pop());
                };
                list.appendChild(li);
            });
        }

        updateCacheInfo();
    </script>
</body>
</html>
